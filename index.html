<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Carey–Foster Bridge • Pro</title>
  <style>
    :root{
      --bg: #f8fafc; --ink: #0f172a; --muted:#475569; --panel:#ffffff;
      --ring:#94a3b8; --accent:#22c55e; --accent-ink:#166534;
      --border:#e2e8f0; --warn:#ef4444;
      --shadow: 0 6px 18px rgba(2,6,23,.08);
    }
    [data-theme="dark"]{
      --bg:#0b1220; --ink:#e6edf7; --muted:#93a4bf; --panel:#0f172a;
      --ring:#334155; --accent:#22c55e; --accent-ink:#86efac;
      --border:#1e293b; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: system-ui, sans-serif;
      color:var(--ink); background:var(--bg); }
    h1{ font-size:1.6rem; margin:.4rem 0 .2rem; }
    h2{ font-size:1.1rem; margin:0 0 .5rem; }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px; display:grid; gap:16px; }
    header{ display:flex; justify-content:space-between; align-items:end; gap:12px; flex-wrap:wrap; }
    .muted{ color:var(--muted); font-size:.92rem; }
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow); }
    .grid-3{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:16px; }
    @media (min-width: 950px){ .grid-3{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
    .row{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; margin:8px 0; }
    .inline{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    input[type="number"]{
      width: 150px; padding:9px 10px; border-radius:10px; border:1px solid var(--border); background: transparent;
      color:var(--ink);
    }
    input[type="range"]{ width:100%; }
    .btn{ background:var(--ink); color:#fff; padding:10px 14px; border:0; border-radius:14px; cursor:pointer; box-shadow:var(--shadow); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn.alt{ background:var(--accent); color:#052e16; }
    .btn.ghost{ background:transparent; color:var(--ink); border:1px solid var(--border); }

    /* Dark mode button fixes */
    [data-theme="dark"] .btn{ background:#1e293b; color:#e2e8f0; }
    [data-theme="dark"] .btn.alt{ background:var(--accent); color:#052e16; }
    [data-theme="dark"] .btn.ghost{ background:transparent; color:#e2e8f0; border:1px solid var(--ring); }

    .kv{ background:rgba(148,163,184,.08); border:1px solid var(--border); border-radius:12px; padding:10px; }
    .kv .k{ font-size:.72rem; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); }
    .kv .v{ font-variant-numeric: tabular-nums; font-weight:600; }
    footer{ text-align:center; color:var(--muted); font-size:.8rem; padding:6px 0 0; }
    label.switch{ position:relative; display:inline-block; width:48px; height:28px; }
    label.switch input{ opacity:0; width:0; height:0; }
    label.switch .slider{ position:absolute; inset:0; background:#cbd5e1; border-radius:999px; transition:.2s; }
    [data-theme="dark"] label.switch .slider{ background:#334155; }
    label.switch .slider:before{ content:""; position:absolute; height:22px; width:22px; left:3px; top:3px; background:white; border-radius:999px; transition:.2s; }
    label.switch input:checked + .slider{ background: var(--accent); }
    label.switch input:checked + .slider:before{ transform: translateX(20px); }
    .rightcol{ display:grid; grid-template-columns:1fr 360px; gap:16px; align-items:start; }
    @media (max-width: 1050px){ .rightcol{ grid-template-columns: 1fr; } }
    .svgbox{ width:100%; height:auto; }
    details{ border:1px dashed var(--border); border-radius:12px; padding:10px 12px; }
    .badge{ border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:.75rem; }
    .pill{ background:rgba(34,197,94,.15); color:var(--accent-ink); padding:4px 8px; border-radius:999px; font-size:.8rem; }
    .log{ width:100%; border-collapse: collapse; font-size:.92rem; }
    .log th, .log td{ border-bottom:1px solid var(--border); padding:6px 8px; text-align:right; }
    .log th:first-child,.log td:first-child{ text-align:left; }
    canvas{ width:100%; height:220px; border:1px solid var(--border); border-radius:12px; background:rgba(148,163,184,.06); }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div>
        <h1>Virtual Carey–Foster Bridge</h1>
        <p class="muted">Interactive simulation of resistance measurement</p>
      </div>
      <label class="switch">
        <input type="checkbox" id="themeToggle"><span class="slider"></span>
      </label>
    </header>

    <div class="grid-3">
      <div class="panel">
        <h2>Bridge Arms</h2>
        <div class="row"><label>X (Ω)</label><input id="resX" type="number" value="10"></div>
        <div class="row"><label>Y (Ω)</label><input id="resY" type="number" value="10.2"></div>
        <div class="row"><label>P (Ω)</label><input id="resP" type="number" value="100"></div>
        <div class="row"><label>Q (Ω)</label><input id="resQ" type="number" value="100"></div>
      </div>

      <div class="panel">
        <h2>Wire &amp; Environment</h2>
        <div class="row"><label>Length (cm)</label><input id="wireLen" type="number" value="100"></div>
        <div class="row"><label>Res/ cm (Ω)</label><input id="wireRes" type="number" value="0.01"></div>
        <div class="row"><label>Temperature (°C)</label><input id="temp" type="number" value="25"></div>
      </div>

      <div class="panel">
        <h2>Controls</h2>
        <div class="inline">
          <button class="btn alt" onclick="resetExp()">Reset</button>
          <button class="btn ghost" onclick="scanAndPlot()">Scan</button>
          <button class="btn" onclick="logReading()">Log Reading</button>
          <button class="btn ghost" onclick="exportCSV()">Export CSV</button>
        </div>
      </div>
    </div>

    <div class="rightcol">
      <div class="panel">
        <svg id="bridgeSVG" class="svgbox" viewBox="0 0 600 200">
          <line x1="50" y1="100" x2="550" y2="100" stroke="black" stroke-width="2"/>
          <circle id="jockey" cx="300" cy="100" r="10" fill="#22c55e" cursor="pointer"/>
        </svg>
        <div style="text-align:center; margin-top:10px;">
          <canvas id="galvo" width="200" height="200"></canvas>
        </div>
      </div>

      <div class="panel">
        <h2>Readings</h2>
        <table class="log" id="logTable">
          <thead><tr><th>#</th><th>l₁ (cm)</th><th>l₂ (cm)</th><th>ΔR (Ω)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <h2>Deflection vs Position</h2>
      <canvas id="plot" width="600" height="250"></canvas>
    </div>
  </div>

  <script>
    const state = {
      X:10, Y:10.2, P:100, Q:100, L:100, rw:0.01,
      pos:0.5, l1:null, l2:null
    };

    const resX=document.getElementById("resX"),
          resY=document.getElementById("resY"),
          resP=document.getElementById("resP"),
          resQ=document.getElementById("resQ"),
          wireLen=document.getElementById("wireLen"),
          wireRes=document.getElementById("wireRes");

    [resX,resY,resP,resQ,wireLen,wireRes].forEach(inp=>{
      inp.addEventListener("input",()=>{
        state.X=parseFloat(resX.value);
        state.Y=parseFloat(resY.value);
        state.P=parseFloat(resP.value);
        state.Q=parseFloat(resQ.value);
        state.L=parseFloat(wireLen.value);
        state.rw=parseFloat(wireRes.value);
      });
    });

    const jockey=document.getElementById("jockey"),
          svg=document.getElementById("bridgeSVG");

    let dragging=false;
    svg.addEventListener("mousedown",e=>{
      if(e.target===jockey) dragging=true;
    });
    svg.addEventListener("mouseup",()=>dragging=false);
    svg.addEventListener("mousemove",e=>{
      if(dragging){
        let pt=svg.createSVGPoint();
        pt.x=e.clientX; pt.y=e.clientY;
        let cursorpt=pt.matrixTransform(svg.getScreenCTM().inverse());
        let x=Math.max(50,Math.min(550,cursorpt.x));
        jockey.setAttribute("cx",x);
        state.pos=(x-50)/500;
        drawGalvo();
      }
    });

    const galvo=document.getElementById("galvo"),
          gctx=galvo.getContext("2d");
    function deflectionAt(l){
      let R1=state.P, R2=state.Q;
      let X=state.X, Y=state.Y;
      let rw=state.rw;
      let lres=rw*l, rres=rw*(state.L-l);
      let vleft=(X+lres)/(X+Y+state.L*rw);
      let vright=(R1)/(R1+R2);
      let diff=vleft-vright;
      return {mag:Math.abs(diff)*2,sign:Math.sign(diff)};
    }
    function drawGalvo(){
      gctx.clearRect(0,0,galvo.width,galvo.height);
      gctx.beginPath();
      gctx.arc(100,100,90,0,2*Math.PI);
      gctx.strokeStyle="#94a3b8";
      gctx.stroke();
      let d=deflectionAt(state.pos*state.L);
      let angle=d.sign*d.mag*Math.PI/3;
      gctx.beginPath();
      gctx.moveTo(100,100);
      gctx.lineTo(100+70*Math.sin(angle),100-70*Math.cos(angle));
      gctx.strokeStyle="#22c55e"; gctx.lineWidth=3; gctx.stroke();
    }
    drawGalvo();

    const plot=document.getElementById("plot"),
          ctx=plot.getContext("2d");
    function clearPlot(){
      ctx.clearRect(0,0,plot.width,plot.height);
      ctx.strokeStyle="#94a3b8";
      ctx.strokeRect(50,30,plot.width-100,plot.height-60);
    }
    function lerp(a,b,t){ return a+(b-a)*t; }
    function scanAndPlot(){
      clearPlot();
      const w=plot.width,h=plot.height;
      const left=60,right=w-60,top=30,bottom=h-30;
      ctx.save();
      ctx.beginPath();
      let first=true;
      for(let i=0;i<=200;i++){
        const l=state.L*i/200;
        const d=deflectionAt(l);
        const x=lerp(left,right,l/state.L);
        const y=(h-60)/2 - d.mag*d.sign*(h-60)/2 + 30;
        if(first){ ctx.moveTo(x,y); first=false; } else ctx.lineTo(x,y);
      }
      ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent');
      ctx.lineWidth=2; ctx.stroke();
      ctx.restore();

      const mark=(l,color)=>{
        if(l==null)return;
        const x=lerp(left,right,l/state.L);
        ctx.save();ctx.strokeStyle=color;ctx.setLineDash([6,4]);
        ctx.beginPath();ctx.moveTo(x,top);ctx.lineTo(x,bottom);
        ctx.stroke();ctx.restore();
      };
      mark(state.l1,'#3b82f6'); // blue for l1
      mark(state.l2,'#ef4444'); // red for l2
    }

    let readingCount=0;
    function logReading(){
      let l=state.pos*state.L;
      if(state.l1===null){ state.l1=l; }
      else if(state.l2===null){ state.l2=l; }
      let tbody=document.querySelector("#logTable tbody");
      let row=document.createElement("tr");
      readingCount++;
      let dr="";
      if(state.l1!==null && state.l2!==null){
        dr=((state.l1-state.l2)*state.rw).toFixed(4);
      }
      row.innerHTML=`<td>${readingCount}</td><td>${state.l1?state.l1.toFixed(2):""}</td><td>${state.l2?state.l2.toFixed(2):""}</td><td>${dr}</td>`;
      tbody.appendChild(row);
      scanAndPlot();
    }
    function resetExp(){
      state.l1=null; state.l2=null; readingCount=0;
      document.querySelector("#logTable tbody").innerHTML="";
      clearPlot(); drawGalvo();
    }
    function exportCSV(){
      let rows=[["#","l1","l2","ΔR"]];
      document.querySelectorAll("#logTable tbody tr").forEach(tr=>{
        let cols=[...tr.children].map(td=>td.innerText);
        rows.push(cols);
      });
      let csv=rows.map(r=>r.join(",")).join("\\n");
      let blob=new Blob([csv],{type:"text/csv"});
      let a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="carey_foster.csv";a.click();
    }

    const themeToggle=document.getElementById("themeToggle");
    themeToggle.addEventListener("change",()=>{
      document.documentElement.setAttribute("data-theme",themeToggle.checked?"dark":"light");
    });
  </script>
</body>
</html>
